// Copyright 2024 Google LLC
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//      http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

package v1alpha1

// +kcc:proto=google.cloud.iap.v1.AccessDeniedPageSettings
type AccessDeniedPageSettings struct {
	// The URI to be redirected to when access is denied.
	AccessDeniedPageUri *string `json:"accessDeniedPageUri,omitempty"`

	// Whether to generate a troubleshooting URL on access denied events to this
	//  application.
	GenerateTroubleshootingUri *bool `json:"generateTroubleshootingUri,omitempty"`

	// Whether to generate remediation token on access denied events to this
	//  application.
	RemediationTokenGenerationEnabled *bool `json:"remediationTokenGenerationEnabled,omitempty"`
}

// +kcc:proto=google.cloud.iap.v1.AccessSettings
type AccessSettings struct {
	// GCIP claims and endpoint configurations for 3p identity providers.
	GcipSettings *GcipSettings `json:"gcipSettings,omitempty"`

	// Configuration to allow cross-origin requests via IAP.
	CorsSettings *CorsSettings `json:"corsSettings,omitempty"`

	// Settings to configure IAP's OAuth behavior.
	OauthSettings *OAuthSettings `json:"oauthSettings,omitempty"`

	// Settings to configure reauthentication policies in IAP.
	ReauthSettings *ReauthSettings `json:"reauthSettings,omitempty"`

	// Settings to configure and enable allowed domains.
	AllowedDomainsSettings *AllowedDomainsSettings `json:"allowedDomainsSettings,omitempty"`
}

// +kcc:proto=google.cloud.iap.v1.AllowedDomainsSettings
type AllowedDomainsSettings struct {
	// Configuration for customers to opt in for the feature.
	Enable *bool `json:"enable,omitempty"`

	// List of trusted domains.
	Domains []string `json:"domains,omitempty"`
}

// +kcc:proto=google.cloud.iap.v1.ApplicationSettings
type ApplicationSettings struct {
	// Settings to configure IAP's behavior for a service mesh.
	CsmSettings *CsmSettings `json:"csmSettings,omitempty"`

	// Customization for Access Denied page.
	AccessDeniedPageSettings *AccessDeniedPageSettings `json:"accessDeniedPageSettings,omitempty"`

	// The Domain value to set for cookies generated by IAP. This value is not
	//  validated by the API, but will be ignored at runtime if invalid.
	CookieDomain *string `json:"cookieDomain,omitempty"`

	// Settings to configure attribute propagation.
	AttributePropagationSettings *AttributePropagationSettings `json:"attributePropagationSettings,omitempty"`
}

// +kcc:proto=google.cloud.iap.v1.AttributePropagationSettings
type AttributePropagationSettings struct {
	// Raw string CEL expression. Must return a list of attributes. A maximum of
	//  45 attributes can be selected. Expressions can select different attribute
	//  types from `attributes`: `attributes.saml_attributes`,
	//  `attributes.iap_attributes`. The following functions are supported:
	//
	//   - filter `<list>.filter(<iter_var>, <predicate>)`: Returns a subset of
	//   `<list>` where `<predicate>` is true for every item.
	//
	//   - in `<var> in <list>`: Returns true if `<list>` contains `<var>`.
	//
	//   - selectByName `<list>.selectByName(<string>)`: Returns the attribute
	//   in
	//   `<list>` with the given `<string>` name, otherwise returns empty.
	//
	//   - emitAs `<attribute>.emitAs(<string>)`: Sets the `<attribute>` name
	//   field to the given `<string>` for propagation in selected output
	//   credentials.
	//
	//   - strict `<attribute>.strict()`: Ignores the `x-goog-iap-attr-` prefix
	//   for the provided `<attribute>` when propagating with the `HEADER` output
	//   credential, such as request headers.
	//
	//   - append `<target_list>.append(<attribute>)` OR
	//   `<target_list>.append(<list>)`: Appends the provided `<attribute>` or
	//   `<list>` to the end of `<target_list>`.
	//
	//  Example expression: `attributes.saml_attributes.filter(x, x.name in
	//  ['test']).append(attributes.iap_attributes.selectByName('exact').emitAs('custom').strict())`
	Expression *string `json:"expression,omitempty"`

	// Which output credentials attributes selected by the CEL expression should
	//  be propagated in. All attributes will be fully duplicated in each selected
	//  output credential.
	OutputCredentials []string `json:"outputCredentials,omitempty"`

	// Whether the provided attribute propagation settings should be evaluated on
	//  user requests. If set to true, attributes returned from the expression will
	//  be propagated in the set output credentials.
	Enable *bool `json:"enable,omitempty"`
}

// +kcc:proto=google.cloud.iap.v1.CorsSettings
type CorsSettings struct {
	// Configuration to allow HTTP OPTIONS calls to skip authorization. If
	//  undefined, IAP will not apply any special logic to OPTIONS requests.
	AllowHTTPOptions *bool `json:"allowHTTPOptions,omitempty"`
}

// +kcc:proto=google.cloud.iap.v1.CsmSettings
type CsmSettings struct {
	// Audience claim set in the generated RCToken. This value is not validated by
	//  IAP.
	RctokenAud *string `json:"rctokenAud,omitempty"`
}

// +kcc:proto=google.cloud.iap.v1.GcipSettings
type GcipSettings struct {
	// GCIP tenant ids that are linked to the IAP resource.
	//  tenant_ids could be a string beginning with a number character to indicate
	//  authenticating with GCIP tenant flow, or in the format of _<ProjectNumber>
	//  to indicate authenticating with GCIP agent flow.
	//  If agent flow is used, tenant_ids should only contain one single element,
	//  while for tenant flow, tenant_ids can contain multiple elements.
	TenantIds []string `json:"tenantIds,omitempty"`

	// Login page URI associated with the GCIP tenants.
	//  Typically, all resources within the same project share the same login page,
	//  though it could be overridden at the sub resource level.
	LoginPageUri *string `json:"loginPageUri,omitempty"`
}

// +kcc:proto=google.cloud.iap.v1.IapSettings
type IapSettings struct {
	// Required. The resource name of the IAP protected resource.
	Name *string `json:"name,omitempty"`

	// Top level wrapper for all access related setting in IAP
	AccessSettings *AccessSettings `json:"accessSettings,omitempty"`

	// Top level wrapper for all application related settings in IAP
	ApplicationSettings *ApplicationSettings `json:"applicationSettings,omitempty"`
}

// +kcc:proto=google.cloud.iap.v1.OAuthSettings
type OAuthSettings struct {
	// Domain hint to send as hd=? parameter in OAuth request flow. Enables
	//  redirect to primary IDP by skipping Google's login screen.
	//  https://developers.google.com/identity/protocols/OpenIDConnect#hd-param
	//  Note: IAP does not verify that the id token's hd claim matches this value
	//  since access behavior is managed by IAM policies.
	LoginHint *string `json:"loginHint,omitempty"`

	// List of OAuth client IDs allowed to programmatically authenticate with IAP.
	ProgrammaticClients []string `json:"programmaticClients,omitempty"`
}

// +kcc:proto=google.cloud.iap.v1.ReauthSettings
type ReauthSettings struct {
	// Reauth method requested.
	Method *string `json:"method,omitempty"`

	// Reauth session lifetime, how long before a user has to reauthenticate
	//  again.
	MaxAge *string `json:"maxAge,omitempty"`

	// How IAP determines the effective policy in cases of hierarchial policies.
	//  Policies are merged from higher in the hierarchy to lower in the hierarchy.
	PolicyType *string `json:"policyType,omitempty"`
}
